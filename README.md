# simple-demo

## 抖音项目服务端简单示例

具体功能内容参考飞书说明文档

工程无其他依赖，直接编译运行即可

```shell
go build && ./simple-demo
```

### 功能说明

接口功能不完善，仅作为示例

* 用户登录数据保存在内存中，单次运行过程中有效
* 视频上传后会保存到本地 public 目录中，访问时用 127.0.0.1:8080/static/video_name 即可

### 测试

test 目录下为不同场景的功能测试case，可用于验证功能实现正确性

其中 common.go 中的 _serverAddr_ 为服务部署的地址，默认为本机地址，可以根据实际情况修改

测试数据写在 demo_data.go 中，用于列表接口的 mock 测试

# 更新日志
## v1.0
技术栈：gin,gorm,mysql,viper(用于配置文件),bcrypt(密码加密，本来用MD5加盐加密，后面想到还要存盐值不安全，便改为bcrypt，而且查阅资料得该加密更安全),go-jwt，ffmpeg(获取视频封面)  
由于是初代版本，总体写下来的感觉大部分都是  
1.(最主要)gorm对数据库的增删改查  
2.gin框架相关编写设计jwt的中间键鉴权，跨域CORS中间键编写，以及获取合法token情况下的user信息  

# 接口实现
## 1./douyin/feed/ - 视频流接口（难点）
1.遇到的第一个问题就是时间的问题，需要留意时间戳是毫秒还是秒（服务端需要返回视频流的最早时间，下次请求会带上这个时间，从而实现不断追溯之前的视频）  
2.遇到的第二个问题就是是否关注了视频的作者（查询用户-粉丝表）以及判断是否点赞，这个就涉及到数据库表格的设计，需要有个用户-视频点赞表  

## 2./douyin/user/register(login)/ - 用户注册(登录)接口
1.比较常规，正常写就可以，只是注册密码需要用bcrypt加密，登录时候需要请求的password和查询数据库获得用户的加密后的密码同样用bcrypt的compare函数进行比对  

## 3. /douyin/user/ - 用户信息
1.很常规，正常响应即可

## 4./douyin/publish/action/ - 视频投稿（难点）
1.首先弄清楚思路，投稿的视频服务器需要有地方存，因此需要将post的视频存在某个文件夹里，并且还需要设置为静态资源，输入url能够访问到的（因为视频流获取视频就是靠url获取）  
2.使用ffmpeg获取视频第一帧作为封面，同理也需要存在某个文件夹里面作为静态资源  
3.**难点！！！** 由于需要对两个数据库（用户表对作品数量++，视频表添加视频信息）,因此使用事务来保证数据安全，一旦出错立即回滚  

## 5./douyin/publish/list/ - 发布列表
1.常规操作，正常读取数据库  

## 6./douyin/favorite/action/ - 赞操作

